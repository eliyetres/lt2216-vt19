<?xml version="1.0" encoding="UTF-8"?>
<vxml version="2.0">
    <nomatch>
        I tried doing what you told me, but nothing happened.
        <reprompt />
    </nomatch>
    <noinput>
        I'm not sure what to do, tell me again.
        <reprompt />
    </noinput>    
    <!-- Data model -->
    <var name="door" />
    <var name="drawer" />
    <var name="table" />
    <var name="window" />
    <var name="key" />
    <var name="selected_item" /> 
    <!-- Global help  -->
    <link event="help">
        <grammar src="grammars/project_grammar.xml#help" />
    </link>
      <!-- Global look around  -->
    <link event="look">
        <grammar src="grammars/project_grammar.xml#look" />
    </link>
          <!-- Global inventory  -->
    <link event="inventory">
        <grammar src="grammars/project_grammar.xml#inventory" />
    </link>
    <!--  Help  -->
    <help count="1">
        Say "look around" and I'll tell you what I see.
        <reprompt />
    </help>
    <help count="2">
    Try giving me commands like "open the door".
</help>
<!--  Inventory  -->
 <inventory>
     <if cond="key == false">
         I'm not carrying anything.
     </if>
     <if cond="key == true">
         I have a key.
     </if>
 </inventory>

<!-- Help menu listing all items and their attributes in the room -->
<look>
    <prompt>
        The items I see are:
        A door that's <value expr="door" />.          
        A window that's  <var name="window" />.
        In the room there is a table with a drawer.
        The drawer is <var name="drawer" />.
        <if cond="drawer == 'open' and key=='false'">               
                Inside the <var name="drawer" /> drawer is a key.                
        </if>
        <if cond="drawer == 'open' and key=='true'">
            The drawer is empty.
        </if>
    </prompt>
    <reprompt/>
</look>


<form id="intro">
    <!-- Set staring states -->
    <assign name="key" expr="false" />
    <assign name="door" expr="locked" />
    <assign name="drawer" expr="closed" />
    <assign name="window" expr="locked" />  
    <!-- =================== -->
   <block>I'm inside a room. I need to figure out how to get <emphasis>out</emphasis> of here.</block>    
   <break size="small"/> 
   <goto next="#maingame"/>
</form>

   
<!-- INTRODUCTION -->
<form id="maingame">
    <grammar src="grammars/project_grammar.xml" />      
    <!--  Part 1 is opening the drawer -->
    <field name="enter_room">
        <if cond="drawer == 'open'">
            <goto nextitem="open_drawer" />
            </if>
         <prompt timeout="120s">I need to figure out what to do.</prompt>
         <grammar src="grammars/project_grammar.xml#item" />  
          <nomatch>
                <block>That didn't work.</block>
            </nomatch>
            <nomatch count="3">
                <block>You told me to <value expr="enter_room$.utterance" /> but I don't know how. Maybe try something else.</block>
            </nomatch> 
            <if cond="enter_room$.interpretation.action == 'open' &amp;&amp; enter_room$.interpretation.item == 'drawer'">                
                    <block> <break size="small"/> I've opened the drawer.</block>
                    <assign name="drawer" expr="open" />                
                   </if>

            <!-- Get info about items in room  -->
            <if cond="enter_room$.interpretation.item == 'door'">
                <block><break size="small"/> The door is <var name="door" />.</block>
            
            <elseif cond="enter_room$.interpretation.item == 'drawer'"/>
                <block><break size="small"/> The drawer is <var name="drawer" />. </block>
            
            <elseif cond="enter_room$.interpretation.item == 'window'"/>
                <block><break size="small"/> The window is <var name="window" />.</block>
            </if>
        </field>
    <!--  Part 2 is opening the drawer -->
    <field name="open_drawer">
        <if cond="key == true">
            <goto nextitem="unlock_door" />
        </if>
        <prompt timeout="120s">I need to find a way out.</prompt>
         <if cond="open_drawer$.interpretation.action == 'open' &amp;&amp; open_drawer$.interpretation.item == 'drawer'">
                <if cond="drawer == 'open'">
                    <prompt>The drawer is already open.</prompt>                    
                </if>
            <if cond="open_drawer$.interpretation.pickup == 'pick up' &amp;&amp; open_drawer$.interpretation.key == 'key'"></if>
                <goto nextitem="unlock_door" />
        </if>
        <filled>
            <assign name="selected_item" expr="open_drawer" />
            </filled>
        </field>
    <!--  Part 3 is getting the key -->    
    <field name="unlock_door">
    <prompt timeout="120s">.</prompt>
    <!-- Get info about items in room  -->
        <if cond="unlock_door$.interpretation.item == 'door'">
            <block><break size="small"/> The door is <var name="door" />.</block>
        
        <elseif cond="unlock_door$.interpretation.item == 'drawer'"/>
            <block><break size="small"/> The drawer is <var name="drawer" />. </block>
        
        <elseif cond="unlock_door$.interpretation.item == 'window'"/>
            <block><break size="small"/> The window is <var name="window" />.</block>
        </if>
        <if cond="unlock_door$.interpretation.action == 'pick up' &amp;&amp; unlock_door$.interpretation.key == 'key'">                
            <block> <break size="small"/> I've opened the drawer.</block>
            <assign name="drawer" expr="open" />                
            </if>

    </field>

        

</form><field id="finished">
    <block>
        You got out and finished the <emphasis>game!</emphasis>
    </block>
    <goto next="exit" />
</field>

</vxml>